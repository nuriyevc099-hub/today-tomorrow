<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Buraxılış</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="buraxlis-page">
  <!-- Page: Buraxılış -->
  <div class="wrap">
  <!-- Header -->
  <header class="top">
      <div class="top-main">
        <h1>NFK</h1>
        <nav>
          <a href="{{ url_for('home') }}">Naryad</a>
          <a href="{{ url_for('users') }}">İstifadəçilər</a>
          <a href="{{ url_for('history') }}">Tarixçə</a>
          <a href="{{ url_for('test_view') }}">Test</a>
          <a class="is-active" href="{{ url_for('buraxlis') }}">Buraxılış</a>
          <a href="{{ url_for('console') }}">Konsol</a>
        </nav>
      </div>
      <div class="top-actions">
        <button
          type="button"
          class="btn btn-ghost"
          onclick="var d=document.getElementById('app-info'); if (d.showModal) d.showModal(); else d.setAttribute('open','open');"
        >İnfo</button>
      </div>
    </header>
    <dialog id="app-info" class="status-dialog info-dialog">
      <div class="dialog-head">
        <h3>İnfo</h3>
        <button type="button" class="icon-btn" onclick="this.closest('dialog').close()">Bağla</button>
      </div>
      <div class="dialog-body info-grid">
        <div class="info-item">
          <div class="info-title">TK</div>
          <div class="info-text">Hər {{ app_info.ttm_cycle_days }} gündən bir hamısı birlikdə seçilir.</div>
        </div>
        <div class="info-item">
          <div class="info-title">TP</div>
          <div class="info-text">Seçilməz.</div>
        </div>
        <div class="info-item">
          <div class="info-title">Tibb Məntəqəsi</div>
          <div class="info-text">Seçilməz.</div>
        </div>
        <div class="info-item">
          <div class="info-title">İcazəli</div>
          <div class="info-text">Seçilməz.</div>
        </div>
        <div class="info-item">
          <div class="info-title">Yeməkxana</div>
          <div class="info-text">Həftə günləri: {{ app_info.yx_days }}. Seçiləndə cooldown: {{ app_info.yx_cooldown }} gün. Gündə max {{ app_info.yx_max_per_day }} nəfər.</div>
        </div>
        <div class="info-item">
          <div class="info-title">2-ci Komando</div>
          <div class="info-text">Status: {{ "ON" if app_info.boluk2_enabled else "OFF" }}. Cycle: {{ app_info.boluk2_cycle_days }} gün. ON olduqda bütün aktivlər birlikdə seçilir, çatmayan yerlər 1-ci komandodan ədalətlə doldurulur.</div>
        </div>
      </div>
    </dialog>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash">
          {% for cat, msg in messages %}
            <div class="flash-item {{cat}}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <section class="card">
      <h2>Buraxılış</h2>
      <div class="muted">Şənbə/Bazar günləri seçilməyəcək istifadəçiləri işarələyin.</div>
      <div class="row">
        <input id="leave-search" type="text" placeholder="İstifadəçi axtar..."/>
      </div>
      <form method="post" action="{{ url_for('buraxlis') }}">
        <h3>Komando 1</h3>
        <div class="leave-grid">
          {% for u in boluk1_users %}
            <label class="leave-item" data-name="{{ u["name"]|lower }}">
              <input type="checkbox" name="user_id" value="{{ u['id'] }}" {% if u['id'] in selected_ids %}checked{% endif %}>
              <span class="leave-name">{{ u["name"] }}</span>
              <span class="leave-tag">B1</span>
            </label>
          {% endfor %}
        </div>

        <h3>Komando 2</h3>
        <div class="leave-grid">
          {% for u in boluk2_users %}
            <label class="leave-item" data-name="{{ u["name"]|lower }}">
              <input type="checkbox" name="user_id" value="{{ u['id'] }}" {% if u['id'] in selected_ids %}checked{% endif %}>
              <span class="leave-name">{{ u["name"] }}</span>
              <span class="leave-tag">B2</span>
            </label>
          {% endfor %}
        </div>

        <div class="row action-row">
          <button class="primary" type="submit">Yadda saxla</button>
        </div>
      </form>
    </section>
  </div>

  <script>
    (function () {
      var input = document.getElementById("leave-search");
      if (!input) return;
      var items = Array.prototype.slice.call(document.querySelectorAll(".leave-item"));
      input.addEventListener("input", function () {
        var q = input.value.trim().toLowerCase();
        items.forEach(function (item) {
          var name = (item.getAttribute("data-name") || "").toLowerCase();
          item.style.display = !q || name.indexOf(q) !== -1 ? "" : "none";
        });
      });
    })();
  </script>
</body>
</html>
